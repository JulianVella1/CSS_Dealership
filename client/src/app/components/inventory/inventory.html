<div class="container mt-4">
  <h2>Admin Inventory Management</h2>

  <div class="card p-3 mb-4 bg-light shadow-sm">
    <h4>@if (isEditing) { Edit Car } @else { Add New Car }</h4>
    <form [formGroup]="carForm" (ngSubmit)="isEditing ? updateCar() : addCar()">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label>Make</label>
          <input type="text" class="form-control" [class.is-invalid]="carForm.get('make')?.invalid && carForm.get('make')?.touched" placeholder="e.g. BMW" formControlName="make">
          @if (carForm.get('make')?.hasError('required') && carForm.get('make')?.touched) {
            <div class="invalid-feedback d-block">Make is required</div>
          }
        </div>
        <div class="col-md-3 mb-3">
          <label>Model</label>
          <input type="text" class="form-control" [class.is-invalid]="carForm.get('model')?.invalid && carForm.get('model')?.touched" placeholder="e.g. X5" formControlName="model">
          @if (carForm.get('model')?.hasError('required') && carForm.get('model')?.touched) {
            <div class="invalid-feedback d-block">Model is required</div>
          }
        </div>
        <div class="col-md-2 mb-3">
          <label>Year</label>
          <input type="number" class="form-control" [class.is-invalid]="carForm.get('year')?.invalid && carForm.get('year')?.touched" formControlName="year">
          @if (carForm.get('year')?.hasError('required') && carForm.get('year')?.touched) {
            <div class="invalid-feedback d-block">Year is required</div>
          }
          @if (carForm.get('year')?.hasError('futureYear') && carForm.get('year')?.touched) {
            <div class="invalid-feedback d-block">Year cannot be in the future</div>
          }
        </div>
        <div class="col-md-2 mb-3">
          <label>Price (€)</label>
          <input type="number" class="form-control" [class.is-invalid]="carForm.get('price')?.invalid && carForm.get('price')?.touched" formControlName="price">
          @if (carForm.get('price')?.hasError('required') && carForm.get('price')?.touched) {
            <div class="invalid-feedback d-block">Price is required</div>
          }
          @if (carForm.get('price')?.hasError('min') && carForm.get('price')?.touched) {
            <div class="invalid-feedback d-block">Price must be non-negative</div>
          }
        </div>
        <div class="col-md-2 mb-3">
          <label>Mileage (km)</label>
          <input type="number" class="form-control" [class.is-invalid]="carForm.get('mileage')?.invalid && carForm.get('mileage')?.touched" formControlName="mileage">
          @if (carForm.get('mileage')?.hasError('min') && carForm.get('mileage')?.touched) {
            <div class="invalid-feedback d-block">Mileage must be non-negative</div>
          }
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-md-2 mb-3">
           <label>Condition</label>
           <select class="form-select" formControlName="condition">
             <option value="New">New</option>
             <option value="Used">Used</option>
             <option value="Certified">Certified</option>
           </select>
        </div>
        <div class="col-md-10 mb-3">
           <label>Image URL</label>
           <input type="text" class="form-control" placeholder="https://..." formControlName="image">
        </div>
      </div>

      <div class="row mt-2">
        <div class="col-md-12 mb-3">
           <label>Description</label>
           <textarea class="form-control" placeholder="Car details..." formControlName="description"></textarea>
        </div>
      </div>

      @if (isEditing) {
        <button type="submit" class="btn btn-primary mt-2">Update Car</button>
        <button type="button" class="btn btn-secondary mt-2 ms-2" (click)="cancelEdit()">Cancel</button>
      } @else {
        <button type="submit" class="btn btn-success mt-2">Add Car</button>
      }
    </form>
  </div>

  <h4 class="mt-4">Current Inventory</h4>
  <table class="table table-striped table-hover border">
    <thead class="table-dark">
      <tr>
        <th>Image</th>
        <th>Make/Model</th>
        <th>Price</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      @for (car of cars; track car._id) {
        <tr>
          <td>
            <img [src]="car.image || 'https://placehold.co/50'" width="60" class="rounded" alt="car">
          </td>
          <td>
            <strong>{{ car.make }} {{ car.model }}</strong><br>
            <small class="text-muted">Year: {{ car.year }}</small><br>
            <small class="text-muted">Mileage: {{ car.mileage ? (car.mileage | number) + ' km' : 'N/A' }}</small>
          </td>
          <td>€{{ car.price }}</td>
          <td>
            <span [class.badge]="true"
                  [class.bg-success]="car.status === 'Available'"
                  [class.bg-danger]="car.status === 'Sold'">
              {{ car.status }}
            </span>
          </td>
          <td>
            <button class="btn btn-warning btn-sm me-2" (click)="startEdit(car)">Edit</button>

            @if (car.status === 'Available') {
              <button class="btn btn-danger btn-sm me-2" (click)="updateCarStatus(car._id, 'Sold')">Mark Sold</button>
            } @else {
              <button class="btn btn-success btn-sm me-2" (click)="updateCarStatus(car._id, 'Available')">Mark Available</button>
            }

            <button class="btn btn-outline-danger btn-sm" (click)="deleteCar(car._id)">Delete</button>
          </td>
        </tr>
      }
    </tbody>
  </table>

  @if (cars.length === 0) {
    <div class="alert alert-info mt-3">
      No cars found. Use the form above to add your first car.
    </div>
  }
</div>
